name: Windows Test

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 5'
  # TODO: https://github.com/otiai10/gosseract/issues/262
  # push:
  #   branches: [main, develop, windows/*]
  # pull_request:
  #   branches: [main, develop]
  push:
    branches: [windows/*]

jobs:
  windows-test:
    runs-on: windows-latest
    name: Windows Test
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Setup Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.18
    - name: Install MinGW
      run: choco install mingw
      shell: powershell
    - name: Add MinGW to PATH
      run: echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> $GITHUB_PATH
      shell: bash
    - name: Cache vcpkg dependencies
      uses: actions/cache@v3
      with:
        path: C:\vcpkg\installed
        key: vcpkg-${{ runner.os }}-${{ hashFiles('**/vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-
    - name: Vcpkg setup
      run: vcpkg integrate install
    - name: Install Leptonica
      run: vcpkg install leptonica:x64-windows --head
    - name: Install Tesseract
      run: vcpkg install tesseract:x64-windows --head
    - name: Check installation
      run: |
        dir C:\vcpkg\installed\x64-windows\include
        dir C:\vcpkg\installed\x64-windows\lib
        dir C:\vcpkg\installed\x64-windows\include\leptonica
    # - name: Env Check
    #   run: Get-ChildItem Env:
    - name: Test Gosseract
      run: |
        CGO_CFLAGS="-I${INCLUDE}" CGO_LDFLAGS="-L${LIB}" go test -x -v -cover ./...
      env:
        INCLUDE: C:\vcpkg\installed\x64-windows\include
        LIB: C:\vcpkg\installed\x64-windows\lib
        PATH: ${{ runner.path }};C:\vcpkg\installed\x64-windows\bin
